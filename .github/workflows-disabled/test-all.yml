name: All Tests

on:
  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'ÐÐ°Ð±Ð¾Ñ€ Ñ‚ÐµÑÑ‚Ð¾Ð² Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - unit-only
          - integration-only
          - e2e-only
          - specialized-only
          - quick
      parallel_execution:
        description: 'ÐŸÐ°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ñ‚ÐµÑÑ‚Ð¾Ð²'
        required: false
        default: true
        type: boolean

  # Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ñ‚ÐµÐ³Ð°
  push:
    tags:
      - 'v*'

  # Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ PR Ð² main
  pull_request:
    branches:
      - main

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10'

jobs:
  # ========================================
  # Unit Tests
  # ========================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.test_suite == 'all' ||
      github.event.inputs.test_suite == 'unit-only' ||
      github.event.inputs.test_suite == 'quick' ||
      github.event.inputs.test_suite == ''
    defaults:
      run:
        working-directory: .

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run unit tests
        run: |
          echo "ðŸ§ª Ð—Ð°Ð¿ÑƒÑÐº Unit Ñ‚ÐµÑÑ‚Ð¾Ð²..."
          docker compose -f docker/docker-compose.test-extended.yaml --profile unit-only up --build --abort-on-container-exit avatar-backend-unit

      - name: Collect unit test results
        if: always()
        run: |
          docker compose -f docker/docker-compose.test-extended.yaml logs avatar-backend-unit > unit-results.log
          echo "## ðŸ§ª Unit Tests - âœ… Completed" >> $GITHUB_STEP_SUMMARY

      - name: Upload unit test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: unit-results.log
          retention-days: 3

      - name: Cleanup unit tests
        if: always()
        run: |
          docker compose -f docker/docker-compose.test-extended.yaml --profile unit-only down --remove-orphans

  # ========================================
  # Integration Tests
  # ========================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.test_suite == 'all' ||
      github.event.inputs.test_suite == 'integration-only' ||
      github.event.inputs.test_suite == ''
    defaults:
      run:
        working-directory: .

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run integration tests
        run: |
          echo "ðŸ”— Ð—Ð°Ð¿ÑƒÑÐº Integration Ñ‚ÐµÑÑ‚Ð¾Ð²..."

          export TEST_DB_DRIVER=postgresql
          export TEST_DB_HOST=localhost
          export TEST_DB_PORT=5433
          export TEST_DB_NAME=avatar_gen_test
          export TEST_DB_USER=test_user
          export TEST_DB_PASSWORD=test_password
          export TEST_STORAGE_TYPE=local

          docker compose -f docker/docker-compose.test-extended.yaml --profile integration-only up --build --abort-on-container-exit avatar-backend-integration

      - name: Collect integration test results
        if: always()
        run: |
          docker compose -f docker/docker-compose.test-extended.yaml logs avatar-backend-integration > integration-results.log
          echo "## ðŸ”— Integration Tests - âœ… Completed" >> $GITHUB_STEP_SUMMARY

      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: integration-results.log
          retention-days: 3

      - name: Upload integration coverage
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/coverage/lcov.info
          flags: integration-all
          name: integration-coverage-all

      - name: Cleanup integration tests
        if: always()
        run: |
          docker compose -f docker/docker-compose.test-extended.yaml --profile integration-only down --remove-orphans

  # ========================================
  # E2E Tests
  # ========================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.test_suite == 'all' ||
      github.event.inputs.test_suite == 'e2e-only' ||
      github.event.inputs.test_suite == ''
    defaults:
      run:
        working-directory: .

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test images
        run: |
          echo "ðŸ—ï¸ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ñ… Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²..."
          docker build -f backend/docker/Dockerfile --target builder -t avatar-gen-test-backend:builder .
          docker build -f frontend/docker/Dockerfile -t avatar-gen-test-frontend:latest .
          docker build -f gateway/Dockerfile -t avatar-gen-test-gateway:latest ./gateway

      - name: Run E2E tests
        run: |
          echo "ðŸŽ­ Ð—Ð°Ð¿ÑƒÑÐº E2E Ñ‚ÐµÑÑ‚Ð¾Ð²..."

          export TEST_DB_DRIVER=postgresql
          export TEST_DB_HOST=localhost
          export TEST_DB_PORT=5433
          export TEST_DB_NAME=avatar_gen_test
          export TEST_DB_USER=test_user
          export TEST_DB_PASSWORD=test_password
          export TEST_STORAGE_TYPE=local

          docker compose -f docker/docker-compose.test-extended.yaml --profile e2e-only up --build --abort-on-container-exit e2e-test-runner

      - name: Collect E2E test results
        if: always()
        run: |
          docker compose -f docker/docker-compose.test-extended.yaml logs e2e-test-runner > e2e-results.log
          echo "## ðŸŽ­ E2E Tests - âœ… Completed" >> $GITHUB_STEP_SUMMARY

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: e2e-results.log
          retention-days: 3

      - name: Upload E2E coverage
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/coverage/lcov.info
          flags: e2e-all
          name: e2e-coverage-all

      - name: Cleanup E2E tests
        if: always()
        run: |
          docker compose -f docker/docker-compose.test-extended.yaml --profile e2e-only down --remove-orphans

  # ========================================
  # Specialized Tests
  # ========================================
  postgres-specialized:
    name: PostgreSQL Specialized Tests
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.test_suite == 'all' ||
      github.event.inputs.test_suite == 'specialized-only' ||
      github.event.inputs.test_suite == ''
    defaults:
      run:
        working-directory: .

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run PostgreSQL specialized tests
        run: |
          echo "ðŸ˜ Ð—Ð°Ð¿ÑƒÑÐº PostgreSQL-ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½Ñ‹Ñ… Ñ‚ÐµÑÑ‚Ð¾Ð²..."

          export TEST_DB_DRIVER=postgresql
          export TEST_DB_HOST=localhost
          export TEST_DB_PORT=5433
          export TEST_DB_NAME=avatar_gen_test
          export TEST_DB_USER=test_user
          export TEST_DB_PASSWORD=test_password
          export TEST_STORAGE_TYPE=local

          docker compose -f docker/docker-compose.test-extended.yaml --profile postgres-tests up --build --abort-on-container-exit avatar-backend-postgres

      - name: Collect PostgreSQL test results
        if: always()
        run: |
          docker compose -f docker/docker-compose.test-extended.yaml logs avatar-backend-postgres > postgres-results.log
          echo "## ðŸ˜ PostgreSQL Tests - âœ… Completed" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup PostgreSQL tests
        if: always()
        run: |
          docker compose -f docker/docker-compose.test-extended.yaml --profile postgres-tests down --remove-orphans

  s3-specialized:
    name: S3 Specialized Tests
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.test_suite == 'all' ||
      github.event.inputs.test_suite == 'specialized-only' ||
      github.event.inputs.test_suite == ''
    defaults:
      run:
        working-directory: .

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run S3 specialized tests
        run: |
          echo "â˜ï¸ Ð—Ð°Ð¿ÑƒÑÐº S3-ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½Ñ‹Ñ… Ñ‚ÐµÑÑ‚Ð¾Ð²..."

          export TEST_STORAGE_TYPE=s3
          export TEST_S3_ENDPOINT=http://localhost:9000
          export TEST_S3_ACCESS_KEY=test-access-key
          export TEST_S3_SECRET_KEY=test-secret-key
          export TEST_S3_BUCKET=avatar-gen-test
          export TEST_S3_REGION=us-east-1
          export TEST_DB_DRIVER=sqlite

          docker compose -f docker/docker-compose.test-extended.yaml --profile s3-tests up --build --abort-on-container-exit avatar-backend-s3

      - name: Collect S3 test results
        if: always()
        run: |
          docker compose -f docker/docker-compose.test-extended.yaml logs avatar-backend-s3 > s3-results.log
          echo "## â˜ï¸ S3 Tests - âœ… Completed" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup S3 tests
        if: always()
        run: |
          docker compose -f docker/docker-compose.test-extended.yaml --profile s3-tests down --remove-orphans

  # ========================================
  # Test Summary
  # ========================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, postgres-specialized, s3-specialized]
    if: always()

    steps:
      - name: Generate comprehensive test summary
        run: |
          echo "## ðŸ§ª Comprehensive Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|----------|" >> $GITHUB_STEP_SUMMARY

          # Unit Tests
          if [ "${{ needs.unit-tests.result }}" = "success" ]; then
            echo "| Unit Tests | âœ… Passed | ~30s |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.unit-tests.result }}" = "skipped" ]; then
            echo "| Unit Tests | â­ï¸ Skipped | - |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Unit Tests | âŒ Failed | - |" >> $GITHUB_STEP_SUMMARY
          fi

          # Integration Tests
          if [ "${{ needs.integration-tests.result }}" = "success" ]; then
            echo "| Integration Tests | âœ… Passed | ~2m |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.integration-tests.result }}" = "skipped" ]; then
            echo "| Integration Tests | â­ï¸ Skipped | - |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Integration Tests | âŒ Failed | - |" >> $GITHUB_STEP_SUMMARY
          fi

          # E2E Tests
          if [ "${{ needs.e2e-tests.result }}" = "success" ]; then
            echo "| E2E Tests | âœ… Passed | ~5m |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.e2e-tests.result }}" = "skipped" ]; then
            echo "| E2E Tests | â­ï¸ Skipped | - |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| E2E Tests | âŒ Failed | - |" >> $GITHUB_STEP_SUMMARY
          fi

          # PostgreSQL Specialized
          if [ "${{ needs.postgres-specialized.result }}" = "success" ]; then
            echo "| PostgreSQL Specialized | âœ… Passed | ~1m |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.postgres-specialized.result }}" = "skipped" ]; then
            echo "| PostgreSQL Specialized | â­ï¸ Skipped | - |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| PostgreSQL Specialized | âŒ Failed | - |" >> $GITHUB_STEP_SUMMARY
          fi

          # S3 Specialized
          if [ "${{ needs.s3-specialized.result }}" = "success" ]; then
            echo "| S3 Specialized | âœ… Passed | ~1m |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.s3-specialized.result }}" = "skipped" ]; then
            echo "| S3 Specialized | â­ï¸ Skipped | - |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| S3 Specialized | âŒ Failed | - |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Test Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Suite**: ${{ github.event.inputs.test_suite || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Parallel Execution**: ${{ github.event.inputs.parallel_execution || 'true' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Compose**: docker-compose.test-extended.yaml" >> $GITHUB_STEP_SUMMARY
          echo "- **Configurations**: Monitored via volume mounts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall result
          FAILED_COUNT=0
          if [ "${{ needs.unit-tests.result }}" = "failure" ]; then ((FAILED_COUNT++)); fi
          if [ "${{ needs.integration-tests.result }}" = "failure" ]; then ((FAILED_COUNT++)); fi
          if [ "${{ needs.e2e-tests.result }}" = "failure" ]; then ((FAILED_COUNT++)); fi
          if [ "${{ needs.postgres-specialized.result }}" = "failure" ]; then ((FAILED_COUNT++)); fi
          if [ "${{ needs.s3-specialized.result }}" = "failure" ]; then ((FAILED_COUNT++)); fi

          if [ $FAILED_COUNT -eq 0 ]; then
            echo "### ðŸŽ‰ Overall Result: ALL TESTS PASSED!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ’¥ Overall Result: $FAILED_COUNT test suite(s) failed!" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Test results are available in the individual job artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Coverage reports are uploaded to Codecov" >> $GITHUB_STEP_SUMMARY
