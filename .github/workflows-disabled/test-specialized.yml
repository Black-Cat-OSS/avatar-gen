name: Specialized Tests

on:
  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Ð¢Ð¸Ð¿ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ñ‚ÐµÑÑ‚Ð¾Ð²'
        required: true
        type: choice
        options:
          - postgres
          - s3
          - performance
          - matrix
      config_custom:
        description: 'ÐšÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ (JSON)'
        required: false
        type: string
        default: '{}'

  # Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¸ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¹
  push:
    paths:
      - 'backend/configs/settings.test.postgres.yaml'
      - 'backend/configs/settings.test.s3.yaml'
      - 'backend/configs/settings.test.minio.yaml'

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10'

jobs:
  postgres-tests:
    name: PostgreSQL Specialized Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'postgres' || github.event.inputs.test_type == ''
    defaults:
      run:
        working-directory: .

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run PostgreSQL specialized tests
        run: |
          echo "ðŸ˜ Ð—Ð°Ð¿ÑƒÑÐº PostgreSQL-ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½Ñ‹Ñ… Ñ‚ÐµÑÑ‚Ð¾Ð²..."

          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ PostgreSQL
          export TEST_DB_DRIVER=postgresql
          export TEST_DB_HOST=localhost
          export TEST_DB_PORT=5433
          export TEST_DB_NAME=avatar_gen_test
          export TEST_DB_USER=test_user
          export TEST_DB_PASSWORD=test_password
          export TEST_STORAGE_TYPE=local

          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ PostgreSQL-ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹
          docker compose -f docker/docker-compose.test-extended.yaml --profile postgres-tests up --build --abort-on-container-exit avatar-backend-postgres

          echo "âœ… PostgreSQL Ñ‚ÐµÑÑ‚Ñ‹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ñ‹"

      - name: Collect test results
        if: always()
        run: |
          docker compose -f docker/docker-compose.test-extended.yaml logs avatar-backend-postgres > postgres-test-results.log

          echo "## ðŸ˜ PostgreSQL Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Database: PostgreSQL" >> $GITHUB_STEP_SUMMARY
          echo "- Storage: Local filesystem" >> $GITHUB_STEP_SUMMARY
          echo "- Config: settings.test.postgres.yaml" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker/docker-compose.test-extended.yaml --profile postgres-tests down --remove-orphans

  s3-tests:
    name: S3/MinIO Specialized Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 's3' || github.event.inputs.test_type == ''
    defaults:
      run:
        working-directory: .

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run S3/MinIO specialized tests
        run: |
          echo "â˜ï¸ Ð—Ð°Ð¿ÑƒÑÐº S3/MinIO-ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½Ñ‹Ñ… Ñ‚ÐµÑÑ‚Ð¾Ð²..."

          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ S3
          export TEST_STORAGE_TYPE=s3
          export TEST_S3_ENDPOINT=http://localhost:9000
          export TEST_S3_ACCESS_KEY=test-access-key
          export TEST_S3_SECRET_KEY=test-secret-key
          export TEST_S3_BUCKET=avatar-gen-test
          export TEST_S3_REGION=us-east-1
          export TEST_DB_DRIVER=sqlite

          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ S3-ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹
          docker compose -f docker/docker-compose.test-extended.yaml --profile s3-tests up --build --abort-on-container-exit avatar-backend-s3

          echo "âœ… S3 Ñ‚ÐµÑÑ‚Ñ‹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ñ‹"

      - name: Collect test results
        if: always()
        run: |
          docker compose -f docker/docker-compose.test-extended.yaml logs avatar-backend-s3 > s3-test-results.log

          echo "## â˜ï¸ S3/MinIO Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Storage: S3/MinIO" >> $GITHUB_STEP_SUMMARY
          echo "- Database: SQLite" >> $GITHUB_STEP_SUMMARY
          echo "- Config: settings.test.s3.yaml" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker/docker-compose.test-extended.yaml --profile s3-tests down --remove-orphans

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'performance' || github.event.inputs.test_type == ''
    defaults:
      run:
        working-directory: .

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run performance tests
        run: |
          echo "âš¡ Ð—Ð°Ð¿ÑƒÑÐº performance Ñ‚ÐµÑÑ‚Ð¾Ð²..."

          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ performance Ñ‚ÐµÑÑ‚Ð¾Ð²
          export TEST_DB_DRIVER=postgresql
          export TEST_DB_HOST=localhost
          export TEST_DB_PORT=5433
          export TEST_DB_NAME=avatar_gen_test
          export TEST_DB_USER=test_user
          export TEST_DB_PASSWORD=test_password
          export TEST_STORAGE_TYPE=local
          export TEST_LOG_LEVEL=warn

          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ performance Ñ‚ÐµÑÑ‚Ñ‹
          docker compose -f docker/docker-compose.test-extended.yaml --profile performance-tests up --build --abort-on-container-exit avatar-backend-performance

          echo "âœ… Performance Ñ‚ÐµÑÑ‚Ñ‹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ñ‹"

      - name: Collect test results
        if: always()
        run: |
          docker compose -f docker/docker-compose.test-extended.yaml logs avatar-backend-performance > performance-test-results.log

          echo "## âš¡ Performance Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Database: PostgreSQL" >> $GITHUB_STEP_SUMMARY
          echo "- Storage: Local filesystem" >> $GITHUB_STEP_SUMMARY
          echo "- Log Level: WARN (optimized)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker/docker-compose.test-extended.yaml --profile performance-tests down --remove-orphans

  matrix-tests:
    name: Custom Matrix Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'matrix' || github.event.inputs.test_type == ''
    defaults:
      run:
        working-directory: .

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Parse custom config
        id: custom-config
        run: |
          CUSTOM_CONFIG='${{ github.event.inputs.config_custom }}'
          echo "CUSTOM_CONFIG=$CUSTOM_CONFIG" >> $GITHUB_OUTPUT

          if [ "$CUSTOM_CONFIG" != "{}" ] && [ "$CUSTOM_CONFIG" != "" ]; then
            echo "Parsing custom configuration: $CUSTOM_CONFIG"
            echo "$CUSTOM_CONFIG" | jq -r 'to_entries[] | "export \(.key)=\(.value)"' > custom_env.sh
            echo "CUSTOM_ENV_FILE=custom_env.sh" >> $GITHUB_OUTPUT
          else
            echo "CUSTOM_ENV_FILE=" >> $GITHUB_OUTPUT
          fi

      - name: Run custom matrix tests
        run: |
          echo "ðŸ”„ Ð—Ð°Ð¿ÑƒÑÐº ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ñ… Ð¼Ð°Ñ‚Ñ€Ð¸Ñ‡Ð½Ñ‹Ñ… Ñ‚ÐµÑÑ‚Ð¾Ð²..."

          # Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ
          if [ -n "${{ steps.custom-config.outputs.CUSTOM_ENV_FILE }}" ] && [ -f "${{ steps.custom-config.outputs.CUSTOM_ENV_FILE }}" ]; then
            echo "Loading custom environment variables..."
            source ${{ steps.custom-config.outputs.CUSTOM_ENV_FILE }}
            cat ${{ steps.custom-config.outputs.CUSTOM_ENV_FILE }}
          fi

          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ
          export TEST_DB_DRIVER=${TEST_DB_DRIVER:-postgresql}
          export TEST_STORAGE_TYPE=${TEST_STORAGE_TYPE:-local}

          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ðµ Ð¼Ð°Ñ‚Ñ€Ð¸Ñ‡Ð½Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹
          docker compose -f docker/docker-compose.test-extended.yaml --profile matrix-tests up --build --abort-on-container-exit test-runner

          echo "âœ… ÐšÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ðµ Ð¼Ð°Ñ‚Ñ€Ð¸Ñ‡Ð½Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ñ‹"

      - name: Collect test results
        if: always()
        run: |
          docker compose -f docker/docker-compose.test-extended.yaml logs test-runner > matrix-test-results.log

          echo "## ðŸ”„ Custom Matrix Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Custom Config: ${{ github.event.inputs.config_custom }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker/docker-compose.test-extended.yaml --profile matrix-tests down --remove-orphans
